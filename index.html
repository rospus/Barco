<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BARCO - Home</title>
    <!-- Include Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Include Google Font (Roboto) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Include Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/index.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
        }
        .header {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .btn-start {
            margin-top: 40px;
            background-color: #007bff;
            color: white;
        }
        .small-text {
            font-size: 0.6em;
            line-height: 1.2;
            display: inline-block;
            margin-left: 10px;
            vertical-align: top;
        }
        .gps-container {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <header class="header">BARCO</header>
    <main class="content">
        <table class="table align-middle border-0 table-borderless">
            <tbody>
                <tr>
                    <td style="width: 25%; text-align: right;">Agenzia</td>
                    <td style="width: 55%;">
                        <div class="input-group">
                            <input type="text" id="agencyName" class="form-control" placeholder="Selezionare..." aria-label="Agency Name" disabled>
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="material-icons">menu</span>
                            </button>
                            <ul class="dropdown-menu" id="menuAgencies">
                                <li><a class="dropdown-item" href="#">Monteprandone</a></li>
                                <li><a class="dropdown-item" href="#">Pescara</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#">Altro...</a></li>
                            </ul>
                        </div>
                    </td>
                    <td style="width: 20%;"></td>
                </tr>
                <tr>
                    <td style="text-align: right;">Utente</td>
                    <td>
                        <div class="input-group">
                            <input type="text" id="userName" class="form-control" placeholder="Selezionare..." aria-label="User Name" disabled>
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="material-icons">menu</span>
                            </button>
                            <ul class="dropdown-menu" id="menuUsers">
                                <li><a class="dropdown-item" href="#">Postino 1</a></li>
                                <li><a class="dropdown-item" href="#">Postino 2</a></li>
                                <li><a class="dropdown-item" href="#">Postino 3</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#">Altro...</a></li>
                            </ul>
                        </div>
                    </td>
                    <td></td>
                </tr>
                <tr style="height: 30px;">
                    <td style="text-align: right;">Punti</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="height: 30px;">
                    <td style="text-align: right;">GPS</td>
                    <td id="gps-status"></td>
                    <td id="gps-accuracy"></td>
                </tr>
                <tr style="height: 30px;">
                    <td style="text-align: right;">SaaS</td>
                    <td id="server-status">
                        <div class="d-flex justify-content-center align-items-center">
                            <span class="material-icons"></span>
                            <span class="ms-2">Verifica connessione...</span>
                        </div>
                    </td>
                  <td></td>
                </tr>
            </tbody>
        </table>
        <button class="btn btn-start" id="start-button" onclick="window.location.href='scan.html'">INIZIO SESSIONE</button>
    </main>
    <script>
        // Early check for geolocation availability
        if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser.");
        }

        document.addEventListener('DOMContentLoaded', () => {
            const agencyName = document.getElementById('agencyName');
            const menuAgencies = document.getElementById('menuAgencies');
            const userName = document.getElementById('userName');
            const menuUsers = document.getElementById('menuUsers');

            // Restore GPS and Server Status Functionality
            const gpsStatusCell = document.getElementById('gps-status');
            const gpsAccuracyCell = document.getElementById('gps-accuracy');
            const serverStatusCell = document.getElementById('server-status');

            gpsStatusCell.innerHTML = '<span class="material-icons">autorenew</span> Recupero posizione...';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lon = position.coords.longitude.toFixed(6);
                        const accuracy = Math.round(position.coords.accuracy);
                        const timestamp = new Date(position.timestamp).toISOString();

                        sessionStorage.setItem('lastCoordStored', JSON.stringify({ lat, lon, accuracy, timestamp }));

                        gpsStatusCell.innerHTML = `
                            <div class="gps-container">
                                <span class="material-icons" style="color: green;">gps_fixed</span>
                                <span class="small-text">
                                    ${lat}<br>${lon}
                                </span>
                            </div>
                        `;
                        gpsAccuracyCell.innerHTML = `Â±${accuracy} m`;
                    },
                    error => {
                        gpsStatusCell.innerHTML = '<span class="material-icons" style="color: red;">gps_not_fixed</span>';
                        gpsAccuracyCell.innerHTML = '';
                    }
                );
            } else {
                gpsStatusCell.innerHTML = '<span class="material-icons" style="color: red;">gps_not_fixed</span>';
                gpsAccuracyCell.innerHTML = '';
            }

            fetch('https://gips.xyz/incoming/in_post.php', { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        serverStatusCell.innerHTML = '<span class="material-icons" style="color: green;">sync</span>';
                    } else {
                        serverStatusCell.innerHTML = '<span class="material-icons" style="color: red;">sync_disabled</span>';
                    }
                })
                .catch(() => {
                    serverStatusCell.innerHTML = '<span class="material-icons" style="color: red;">sync_disabled</span>';
                });

            menuAgencies.addEventListener('click', (event) => {
                const selectedOption = event.target.textContent;
                if (selectedOption === 'Monteprandone') {
                    agencyName.value = 'MPR';
                    agencyName.disabled = true;
                    agencyName.placeholder = 'Selezionare...';
                } else if (selectedOption === 'Pescara') {
                    agencyName.value = 'PSC';
                    agencyName.disabled = true;
                    agencyName.placeholder = 'Selezionare...';
                } else if (selectedOption === 'Altro...') {
                    agencyName.disabled = false;
                    agencyName.value = '';
                    agencyName.placeholder = '';
                    agencyName.focus();
                }
            });

            menuUsers.addEventListener('click', (event) => {
                const selectedOption = event.target.textContent;
                if (selectedOption === 'Altro...') {
                    userName.disabled = false;
                    userName.value = '';
                    userName.placeholder = '';
                    userName.focus();
                } else {
                    userName.value = selectedOption;
                    userName.disabled = true;
                    userName.placeholder = 'Selezionare...';
                }
            });
        });
    </script>
    <!-- Include Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
